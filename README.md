# 依赖库
pandas、openpyxl

# 交易策略

- 使用Python编写一个程序，程序功能描述如下：
- 这个程序读取一个Excel数据文件，然后定义突破周期T
- 入市规则：
  - 每次当日价格突破此前T日（当前日之前的T日）最高价格时，以当日前T日最高价格建立1个单位多仓头寸
  - 每次当日价格突破此前T日（当前日但是不包含当日的前T日）最低价格时，以当日前T日最高价格建立1个单位空仓头寸
- 当前ATR计算天数定义为M（当日但不包含当日的前M天）
- 加仓规则为：价格在建仓后，价格每再突破N个当前ATR加仓1个头寸，最多持仓量为4个头寸
- 止损规则为：当前价格与最后一次加仓时候的价格回撤K个入市ATR（建仓日ATR）
- 止盈规则为：当持仓利润超过P个当日ATR时，利润回撤到本次入市的最高利润的比例Q时止盈
- 另外，当数据到达最后一行，如果有持仓，并当天没有止损和止盈条件触发时，以当日收盘价计算离市利润，离市类型为“到期离市”，当止盈和止损同时发生时，按照止损获取的利润和价格计算
- 从第T+1日开始，每天计算当天的最高价、最低价、开盘价、收盘价、ATR、入市时间、入市类型（开多或开空），入市ATR，入市时间、入市价格、多头持仓数量、空头持仓数量、前T日最高价、前T日最高价、本次入市以来最高利润、当前利润、离市类型（止损多平、止损空平、止盈多平、止盈空平、到期离市）离市利润（本行发生离市时记录，否则为None）

# 算法流程

从第T+1日开始，每天执行以下操作：

- 从表格中读取并记录最高价、最低价、开盘价、收盘价、真实波动幅度(TR)，使用TR计算ATR（计算天数为M）
- 计算前T日最高价和最低价
- 入市（建仓）
  - 条件
    - 多仓：当日**最高价**高于此前T日最高价格
    - 空仓：当日**最低价**低于此前T日最低价格
  - 操作
    1. 记录入市时间、入市价格（此前T日最高价格）、入市ATR，入市类型记为“开多”/“开空”
    2. 向多头/空头开仓价列表中添加本次开仓价（入市价），更新上一次开仓价
- 加仓（多头/空头）
  - 条件
    1. 价格条件
       - 多仓：当日**最高价**高于上一次开仓价加上N个当日ATR
       - 空仓：当日**最低价**低于上一次开仓价减去N个当日ATR
    2. 持仓数量小于等于R
  - 操作：向多头/空头开仓价列表中添加本次开仓价（上一次开仓价加/减N个当日ATR）
- 更新当前利润以及入市以来最高利润：使用收盘价作为当前利润计算价格
- 止损（代码写在前面）
  - 条件
    - 多仓：当日**最低价**小于K倍入市ATR和上一次开仓价之**差**
    - 空仓：当日**最高价**大于K倍入市ATR和上一次开仓价之**和**
  - 规则：离市类型设为“止损多平”/”止损空平“，离市价设为K倍入市ATR和上一次开仓价之和/差
- 止盈（代码写在后面）
  - 条件：当前利润超过P个当日ATR时准备止盈，当前利润小于入市以来最高利润的比例Q时正式止盈
  - 规则：离市类型设为“止盈多平”/”止盈空平“，离市价设为入市以来最高利润的比例Q
- 到期离市（代码写在更后面）：离市类型设为”到期离市“，离市价设为收盘价
- 输出当日最高价、最低价、开盘价、收盘价、ATR、入市时间、入市类型，入市ATR，入市时间、入市价格、多头持仓数量、空头持仓数量、前T日最高价、前T日最高价、本次入市以来最高利润、当前利润、离市类型、离市利润。如果当日发生离市，则清除所有与入市和离市相关的数据
